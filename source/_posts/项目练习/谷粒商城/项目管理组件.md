---
title: 谷粒商城-项目整体管理
type:
comments:
tags: 
  - 分布式
  - 微服务
  - SpringBoot
categories: 
  - 项目练习
description: 
keywords: SpringCloud
cover: https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg
top_img: https://w.wallhaven.cc/full/m9/wallhaven-m9873y.jpg
---

项目基础业务代码搭建完毕，此时就需要配置管理中心，也就是：`注册中心`、`配置中心` 和 `网关`。

## 技术选型

​	以往的 Spring Cloud 方案部分组件已经停止维护和更新，同时部分环境搭建复杂没有完善的可视化界面，基本都需要二次开发和定制化，同时配置复杂，难以上手，部分配置差别难以区分和合理应用。Spring Cloud Alibaba 的分布式方案开源且搭建简单，因此选择 Alibaba 的方案进行实现：

1）服务发现与注册中心：`Nacos`（替换原来的 Eureka 方案）

2）动态配置中心：`Nacos`

3）负载均衡方案：`Ribbon`（Spring Cloud Netflix 方案）

4）远程调用服务：`OpenFeign`（Spring Cloud 声明式 HTTP 客户端，替换原来的已经闭源的 Feign）

5）熔断保护和降级：`Sentinel`（替换原来 Spring Cloud Netflix 的 Hystrix 方案）

6）API 网关：`Gateway`（webflux 编程模式网关）

7）调用链监控：`Sleuth + Zipkin` （Spring Cloud 方案）

8）分布式事务处理：`Seata` （Alibaba 的 Fescar 的升级版方案）

## 技术回顾

注：公共模块 common 导入 SpringCloudAlibaba 依赖管理（`由于 Boot 版本 2.1.8，Cloud Alibaba 采用 Greenwich.SR3 版本`）

```xml
<spring-boot.version>2.1.8.RELEASE</spring-boot.version>
<spring-cloud.version>Greenwich.SR3</spring-cloud.version>

<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2.1.0.RELEASE</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### Nacos 注册中心

​	Nacos 是一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台，可以替换 Eureka，作为我们的注册中心和配置中心。

> windows 下的 nacos 进行测试（后续会安装 centos 系统下的 nacos 使用）：
>
> 1）下载地址：`https://github.com/alibaba/nacos/releases`，选择 zip 包即可。
>
> 2）以单机模式启动：
>
> ```shell
> # 进入 bin 目录使用以下命令单机启动（版本低的模式是单机启动,版本高的默认是 all 方式启动也就是集群方式启动）
> startup.cmd -m standalone
> ```
>
> 3）启动后本地访问 `http://localhost:8848/nacos/` 。

1、由于后面的应用都需要注册，则修改 common 中的 pom.xml 文件，引入 Nacos Discovery Starter。

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

2、配置文件配置服务名称以及 nacos-server 地址。（本地测试需要下载 nacos-server 并启动）

```yml
spring:
  datasource:
    username: root
    password: root
    url: jdbc:mysql://8.142.92.222:3333/shop_sms
    driver-class-name: com.mysql.cj.jdbc.Driver
  # 注册中心地址
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
  # 服务名称
  application:
    name: shop-coupon
```

3、启动类添加注解 `@EnableDiscoveryClient` 开启服务发现。

4、此时就可以访问 nacos-server 所在 `IP:port` 的可视化网站来进行查看服务注册情况。

![](https://pic1.imgdb.cn/item/633fdd3816f2c2beb1a040c2.png)

### OpenFeign 远程调用

注：需要先按照上面 nacos 注册的方式将所有的服务都注册到注册中心，而后才能进行远程调用的测试。

Feign 是一个声明式的 HTTP 客户端，他的目的就是让远程调用更加简单。 给远程服务发的是 HTTP 请求，并非 RPC 请求调用方式。

> 注：新版本 Cloud 使用 Feign 需要导入 `spring-cloud-starter-loadbalancer` 依赖，否则会报错。

`[案例]`  获取当前会员领取到的所有优惠券，也就是使用会员服务 member 远程调用优惠券服务 coupon。

1）coupon 的 CouponController 中编写测试调用的方法。

```java
@RequestMapping("/member/list")
public R memberCoupons(){
    CouponEntity couponEntity = new CouponEntity();
    couponEntity.setCouponName("满100减10");
    return R.ok().put("coupons", Arrays.asList(couponEntity));
}
```

2）调用模块 member 引入 OpenFeign，由于 OpenFeign 是声明式调用，则需要编写一个接口，告诉 SpringCloud 这个接口需要调用远程服务。

`[约定]`：所有的调用服务接口都写在 feign 包下。

```java
//参数为服务名
@FeignClient("shop-coupon")
public interface CouponFeignService {
    
    //远程服务的签名，请求路径必须写完整
    @RequestMapping("/member/list")
    public R memberCoupons();
}
```

`[注意]`： 声明接口的每一个方法都是调用该服务的远程方法的请求，同时`请求地址路径需要写全`。

3）调用服务 member 的主启动类开启远程调用功能，并指定具体的远程调用的包名 basePackage。

```java
@EnableFeignClients(basePackages = "com.example.member.feign")
```

4）在 member 的任意 Controller 编写测试请求，调用远程的 memberCoupons 方法获取数据：

```java
@Autowired
CouponFeignService couponFeignService;

@RequestMapping("/coupons")
public R test(){
    MemberEntity memberEntity = new MemberEntity();
    memberEntity.setNickname("张三");
    R memberCoupons = couponFeignService.memberCoupons();
    return R.ok().put("member", memberEntity).put("coupons", memberCoupons.get("coupons"));
}
```

![](https://pic1.imgdb.cn/item/633fe10616f2c2beb1a6a472.png)

### Nacos 配置中心

​	如果使用原来的方式读取配置文件 application.properties 中的数据，那么当需要修改信息时，我们就必须将项目源码的配置文件中的信息进行修改，然后再将项目重新打包，重新部署，非常麻烦，同时如果需要部署多份还得一个个修改部署或重启。使用 `Cloud Config 配置中心`，那么就可以在配置中心更改，使项目配置全改，而这个配置中心就是 Nacos，默认配置项可以从 SpringBoot 的启动日志配置中发现，配置名称默认为：`DataID = "服务名称.properties"` ，配置信息选择 properties。

1、由于后面的应用都需要配置中心，则修改 common 中的 pom.xml 文件，引入 Nacos Config Starter。

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

2、在需要配置中心的项目的 Resources 目录下创建 `bootstrap.properties` 配置文件，并配置：

```properties
spring.application.name=shop-coupon
# 配置中心地址
spring.cloud.nacos.config.server-addr=127.0.0.1:8848
```

3、配置中心的配置列表添加 Data Id 叫 `应用名称.properties` ，在选择 properties 选项，添加对应的配置。

![](https://pic1.imgdb.cn/item/633fe18f16f2c2beb1a774e8.png)

4、需要获取配置中心属性的 Component 上添加注解 `@RefreshScope` 动态获取并刷新配置，而在需要获取属性的位置使用 `@Value("${}")` 注入。

```java
@Value("${coupon.username}")
private String username;

@Value("${coupon.age}")
private int age;
```

注：如果配置中心和当前应用内的配置文件都配置了相同的项，`优先会使用配置中心的属性配置`。

> 如果 cloud 版本过高可能无法启动项目，考虑可能是 bootstrap 配置文件的问题，需要单独引入 bootstrap 依赖：
>
> ```xml
> <dependency>
>     <groupId>org.springframework.cloud</groupId>
>     <artifactId>spring-cloud-starter-bootstrap</artifactId>
>     <version>3.1.4</version>
> </dependency>
> ```

在 Nacos 作配置中心时，会涉及到几个关键点：

1）命名空间：主要是用于配置隔离，默认是 `public(保留空间)`，也就是默认新增的所有配置都在 public 空间下。命名空间的配置隔离机制实现能够在开发、生产、测试等不同环境下的资源隔离，当需要切换环境时，只需要`在 bootstrap.properties 配置文件中执行 namespace `即可。

```properties
# 此处需要填写命名空间 namespace 的唯一 ID
spring.cloud.nacos.config.namespace=xxxxxxx
```

同时也可以针对每一个微服务创建单独的命名空间，只加载自己命名空间下的所有配置项。

2）配置集：所有配置的集合。

3）配置集 ID：类似于文件名，而在 Nacos 中就是指 `Data ID`。

4）配置分组：默认所有的配置都属于 `DEFAULT_GROUP` 组，创建时可以指定配置分组，切换配置分组也是在 bootstrap.properties 配置文件指定：

```properties
spring.cloud.nacos.config.group=dev/prod/test
```

`[约定]` 本项目中约定每个微服务创建自己的命名空间，使用配置分组来区分不同的环境：dev/prod/test 等。

有了配置中心，那么就可以将配置信息都放入到配置中心进行配置，同时针对不同类别的配置信息使用不同的配置集 ID。

1）数据库部分设置 `datasource.yml` 。

```yml
spring:
  datasource:
    username: root
    password: root
    url: jdbc:mysql://8.142.92.222:3333/shop_sms
    driver-class-name: com.mysql.cj.jdbc.Driver
```

2）mybatis 相关配置设置 `mybatis.yml`。

```yml
mybatis-plus:
  mapper-locations: classpath:/mapper/**/*.xml
  global-config:
    db-config:
      id-type: auto
```

3）其他配置 `other.yml` 。

```yml
spring:
  cloud:
    nacos:
      discovery:
        server-addr:
  application:
    name: shop-coupon
server:
  port: 7000
```

再在 `bootstrap.properties` 配置文件中将上述配置加入：

```properties
spring.application.name=shop-coupon
spring.cloud.nacos.config.server-addr=xxx.xxx.xxx.xxx:xxxx
spring.cloud.nacos.config.namespace=xxx
spring.cloud.nacos.config.group=dev
spring.cloud.nacos.config.ext-config[0].data-id=datasource.yml
spring.cloud.nacos.config.ext-config[0].group=dev
spring.cloud.nacos.config.ext-config[0].refresh=true
spring.cloud.nacos.config.ext-config[1].data-id=mybatis.yml
spring.cloud.nacos.config.ext-config[1].group=dev
spring.cloud.nacos.config.ext-config[1].refresh=true
spring.cloud.nacos.config.ext-config[2].data-id=other.yml
spring.cloud.nacos.config.ext-config[2].group=dev
spring.cloud.nacos.config.ext-config[2].refresh=true
```

### Gateway 网关配置

​	网关主要是用于路由、鉴权、限流、日志输出等功能的实现，Gateway 是用于取代原先的 Zuul 网关。

![](https://img-blog.csdnimg.cn/2021021114165622.png)

核心概念：

1）`路由`：客户端发送一个请求给网关，网关要将请求路由到指定的服务，路由需要配置 id、目的地 uri、断言集合以及过滤器集合等，只有当匹配了设定的断言规则后才会被转发到指定位置。

2）`断言`：实际就是一种匹配规则，匹配请求里的任何信息，包括请求头等，只有匹配成功后，请求才会继续向下转发。

3）`过滤`：相当于过滤器，能够在请求头添加信息或是加入鉴权信息等。

1、创建网关项目 `shop-gateway`，是一个 SpringBoot 项目，选中 Gateway 依赖，同时也需要依赖 common 工程，但是需要排除数据库相关配置。

```java
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
```

2、网关也需要将自己注册到注册中心，开启服务注册和发现：

1）主启动类上添加注解 `@EnableDiscoveryClient` 开启服务注册和发现。

2）应用配置文件 application.properties 配置 nacos 注册中心的地址。

```properties
spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
spring.application.name=shop-gateway
server.port=88
```

3）bootstrap.properties 配置文件配置相关配置信息。

```properties
spring.cloud.nacos.config.server-addr=127.0.0.1:8848
spring.application.name=shop-gateway
spring.cloud.nacos.config.namespace=gateway-id
```

4）nacos 配置中心新建命名空间 gateway，id 为 gateway-id ，创建默认基本配置即可。

```yml
spring: 
    application: 
        name: shop-gateway
```

5）测试项目成功启动。

`[案例]` 希望请求地址带上参数从而转发到不同网址，例如参数 baidu 则转发到百度网，参数 qq 转发到腾讯网。

创建一个单独的测试配置文件 application.yml ，并编写对应路由规则：

```yml
spring:
  cloud:
    gateway:
      routes:
        - id: test_baidu_route
          uri: https://www.baidu.com/
          predicates:
            - Query=url,baidu
        - id: test_qq_route
          uri: https://www.qq.com/
          predicates:
            - Query=url,qq
```

启动网关服务，地址栏输入`http://localhost:88?url=baidu` 发现正常跳转到指定页面。
